{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://tensafe.dev/tgsp/manifest-v1.2.json",
  "title": "TGSP Manifest v1.2",
  "description": "JSON Schema for the TenSafe Gated Secure Package manifest, version 1.2. Adds adapter_type, system_capabilities, and tsa_binding for TenSafe System Adapter (TSA) support.",
  "type": "object",
  "required": [
    "format",
    "version",
    "name",
    "domain",
    "adapter_type",
    "model",
    "lora_config",
    "skill",
    "skill_doc",
    "rvu_safety",
    "creator",
    "integrity",
    "signatures"
  ],
  "properties": {
    "format": {
      "type": "string",
      "const": "TGSP",
      "description": "Format identifier. Must be 'TGSP'."
    },
    "version": {
      "type": "string",
      "enum": ["1.1", "1.2"],
      "description": "Manifest schema version. v1.2 adds adapter_type, system_capabilities, and tsa_binding."
    },
    "name": {
      "type": "string",
      "minLength": 1,
      "maxLength": 256,
      "description": "Human-readable adapter name."
    },
    "domain": {
      "type": "string",
      "minLength": 1,
      "maxLength": 128,
      "description": "Domain identifier (e.g. 'medical', 'legal', 'code', 'system')."
    },
    "adapter_type": {
      "type": "string",
      "enum": ["system", "domain", "router"],
      "description": "Adapter classification. 'system' = TenSafe System Adapter (TSA), mandatory and always loaded. 'domain' = domain-specific expert adapter, requires TSA binding. 'router' = dedicated routing adapter."
    },
    "system_capabilities": {
      "type": "object",
      "description": "Capabilities of a system adapter (TSA). Only applicable when adapter_type is 'system'.",
      "properties": {
        "learned_routing": {
          "type": "boolean",
          "default": false,
          "description": "Whether this TSA provides learned expert routing (replaces keyword gates)."
        },
        "system_awareness": {
          "type": "boolean",
          "default": false,
          "description": "Whether this TSA injects system context (metering, privacy budget, adapter info)."
        },
        "output_optimization": {
          "type": "boolean",
          "default": false,
          "description": "Whether this TSA optimizes output length and quality."
        },
        "speculative_draft": {
          "type": "boolean",
          "default": false,
          "description": "Whether this TSA can act as a draft model for speculative decoding."
        },
        "router_num_classes": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of expert classes the TSA router can classify."
        },
        "router_accuracy": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Measured routing accuracy on benchmark set."
        },
        "tsa_version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "Semantic version of this TSA (used for domain adapter compatibility ranges)."
        },
        "runtime_binding_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "SHA-256 hash of the TSA weights, used to verify domain adapter compatibility."
        }
      },
      "additionalProperties": false
    },
    "tsa_binding": {
      "type": "object",
      "description": "TSA binding information for domain adapters. Required when adapter_type is 'domain'. Binds this adapter to a specific TenSafe System Adapter, ensuring it can only load when a compatible TSA is present.",
      "required": [
        "required",
        "tsa_fingerprint",
        "compatibility_hash",
        "min_tsa_version",
        "counter_signature"
      ],
      "properties": {
        "required": {
          "type": "boolean",
          "const": true,
          "description": "TSA binding is always required for domain adapters."
        },
        "tsa_fingerprint": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "SHA-256 fingerprint of the TSA's Ed25519 public key that counter-signed this adapter."
        },
        "compatibility_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "SHA-256(TSA_weights || domain_adapter_weights). Verifies that neither the TSA nor the domain adapter has been tampered with."
        },
        "min_tsa_version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "Minimum TSA version required. Domain adapter will not load with an older TSA."
        },
        "max_tsa_version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "Maximum TSA version supported. Domain adapter will not load with a newer TSA beyond this version."
        },
        "counter_signature": {
          "type": "string",
          "description": "Base64-encoded Ed25519 signature of the domain adapter manifest, signed by the TSA's key. Proves TenSafe approved this adapter for use with the TSA."
        }
      },
      "additionalProperties": false
    },
    "model": {
      "type": "object",
      "required": ["architecture", "base_model", "num_experts", "experts_per_token"],
      "properties": {
        "architecture": {
          "type": "string",
          "description": "Model architecture type (e.g. 'sparse_moe', 'dense', 'mixture_of_experts')."
        },
        "base_model": {
          "type": "string",
          "minLength": 1,
          "description": "Base model identifier (e.g. HuggingFace model ID)."
        },
        "num_experts": {
          "type": "integer",
          "minimum": 1,
          "description": "Total number of MoE experts."
        },
        "experts_per_token": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of experts activated per token."
        }
      },
      "additionalProperties": false
    },
    "lora_config": {
      "$ref": "lora_config.json"
    },
    "skill": {
      "type": "object",
      "required": [
        "description",
        "triggers",
        "capabilities",
        "input_format",
        "output_format",
        "quality_score",
        "compliance",
        "composable_with"
      ],
      "properties": {
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable description of the adapter's purpose."
        },
        "triggers": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Activation triggers or keywords."
        },
        "capabilities": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of capabilities provided by the adapter."
        },
        "input_format": {
          "type": "string",
          "description": "Expected input format (e.g. 'text', 'json', 'image+text')."
        },
        "output_format": {
          "type": "string",
          "description": "Expected output format."
        },
        "quality_score": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Quality metric ranging from 0.0 (lowest) to 1.0 (highest)."
        },
        "compliance": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Compliance standards met (e.g. 'HIPAA', 'SOC2', 'GDPR')."
        },
        "composable_with": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Names of adapters this one can be composed with. Use ['*'] for system adapters composable with all."
        }
      },
      "additionalProperties": false
    },
    "skill_doc": {
      "type": "string",
      "minLength": 50,
      "description": "Full embedded SKILL.md document in markdown format. This is the human- and agent-readable description of what this adapter does, when to use it, its capabilities, compliance, and composition rules. Every TGSP adapter IS a skill file â€” agents read this to decide whether to load the adapter for a given task."
    },
    "rvu_safety": {
      "type": "object",
      "required": [
        "version",
        "layers",
        "screening_passed",
        "screening_timestamp",
        "screening_hash"
      ],
      "properties": {
        "version": {
          "type": "string",
          "const": "RVUv2",
          "description": "RVU safety screening version. Must be 'RVUv2'."
        },
        "layers": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["allowlist", "svd_analysis", "mahalanobis_ood"]
          },
          "minItems": 1,
          "uniqueItems": true,
          "description": "Screening layers applied. Standard layers: allowlist, svd_analysis, mahalanobis_ood."
        },
        "screening_passed": {
          "type": "boolean",
          "description": "Whether the adapter passed all screening layers."
        },
        "screening_timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of when screening was performed."
        },
        "screening_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "SHA-256 hash of the full screening report."
        }
      },
      "additionalProperties": false
    },
    "creator": {
      "type": "object",
      "required": [
        "name",
        "organization",
        "email",
        "public_key_fingerprint",
        "verified"
      ],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Creator display name."
        },
        "organization": {
          "type": "string",
          "description": "Organization name."
        },
        "email": {
          "type": "string",
          "format": "email",
          "description": "Contact email address."
        },
        "public_key_fingerprint": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "SHA-256 fingerprint of the creator's Ed25519 public key."
        },
        "verified": {
          "type": "boolean",
          "description": "Whether the creator's identity has been externally verified."
        }
      },
      "additionalProperties": false
    },
    "integrity": {
      "type": "object",
      "required": ["payload_hash", "manifest_hash", "hash_algorithm"],
      "properties": {
        "payload_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "SHA-256 hex digest of the payload (LoRA weights)."
        },
        "manifest_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "SHA-256 hex digest of the manifest JSON (before signatures)."
        },
        "hash_algorithm": {
          "type": "string",
          "const": "SHA-256",
          "description": "Hash algorithm used. Must be 'SHA-256'."
        }
      },
      "additionalProperties": false
    },
    "signatures": {
      "type": "object",
      "required": ["ed25519", "dilithium3", "signed_fields"],
      "properties": {
        "ed25519": {
          "type": "string",
          "description": "Base64-encoded Ed25519 signature over the signed fields."
        },
        "dilithium3": {
          "type": "string",
          "description": "Base64-encoded Dilithium3 (post-quantum) signature over the signed fields."
        },
        "signed_fields": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 4,
          "uniqueItems": true,
          "contains": { "const": "integrity" },
          "description": "Manifest fields covered by the signatures. Must include 'integrity', 'creator', 'rvu_safety', 'lora_config'."
        }
      },
      "additionalProperties": false
    }
  },
  "allOf": [
    {
      "if": {
        "properties": { "adapter_type": { "const": "domain" } }
      },
      "then": {
        "required": ["tsa_binding"],
        "properties": {
          "tsa_binding": {
            "description": "TSA binding is REQUIRED for domain adapters."
          }
        }
      }
    }
  ],
  "additionalProperties": false
}
